<!-- Created By Logan Stoltz -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Space Invaders</title>
    <style></style>
</head>

<body>
    <canvas id="gameCanvas" width="1000" height="800"></canvas>
    <script>

    /************* CONSTANTS *************/
    // Game Constants
    const FPS = 60; // Frames per Second
    const SHIP_SIZE = 30; // Ship height in pixel
    const SHIP_SPEED = 500; // Acceleration of the ship in pixel per second

    const ENEMY_SHIPS_NUM = 55; // Number of normal enemies
    const ENEMY_SHIP_SIZE = 40; // Enemy height in pixels
    const ENEMY_SHIP_SPEED = 200; // Acceleration of enemies in pixel per second
    const ENEMY_STARTING_X = 10; // Enemies section start x
    const ENEMY_STARTING_Y = 10; // Enemies section start y

    /************* GAME SETUP *************/
    /** @type {HTMLCanvasElement} */
    var canvas = document.getElementById("gameCanvas");
    var context = canvas.getContext("2d");

    // Set up the game parameters
    var ship, level, levelText, levelTextAlpha, enemies;
    newGame();

    // Event Hanlders for user inputs
    document.addEventListener("keydown", keyDown);
    document.addEventListener("keyup", keyUp);

    // Set up the game loop
    setInterval(update, 1000 / FPS);


    /************* FUNCTIONS *************/
    function newShip() {
        return{
            x: canvas.width / 2,
            y: canvas.height * 0.9,
            radius: SHIP_SIZE / 2,
            thrustingLeft: false,
            thrustingRight: false,
            thrust: {
                x: 0
            }
        }
    }

    function drawShip(x, y, color = "green") {
        context.strokeStyle = color;
        context.lineWidth = SHIP_SIZE / 20;
        context.fillStyle = color;
        context.beginPath(); // Front middle of ship
        context.moveTo( // Front Right of ship
            x + SHIP_SIZE - 5,
            y + 0
        );
        context.lineTo( // Rear Right of ship
            x + SHIP_SIZE,
            y + SHIP_SIZE / 1.2
        );
        context.lineTo( // Rear Left of ship
            x - SHIP_SIZE,
            y + SHIP_SIZE / 1.2
        );
        context.lineTo( // Front left of ship
            x - SHIP_SIZE + 5,
            y + 0
        );
        context.closePath();
        context.fill();

        // Ship Gun
        context.lineTo( // Back Left of Gun
            x - 4,
            y + 0
        );
        context.lineTo( // Middle Front of Gun
            x + 0,
            y - SHIP_SIZE / 4
        );
        context.lineTo( // Back Right of Gun
            x + 4,
            y + 0
        );
        context.closePath();
        context.fill();
        context.stroke();
    }

    function drawEnemy(x, y, color = "white") {
        context.strokeStyle = color;
        context.lineWidth = ENEMY_SHIP_SIZE / 20;
        context.fillStyle = color;
        context.beginPath(); // Front middle of enemy
        context.moveTo( // Front Right of enemy
            x + ENEMY_SHIP_SIZE,
            y + 0
        );
        context.lineTo( // Rear Right of enemy
            x + ENEMY_SHIP_SIZE,
            y + ENEMY_SHIP_SIZE
        );
        context.lineTo( // Rear Left of enemy
            x + 0,
            y + ENEMY_SHIP_SIZE
        );
        context.lineTo( // Front left of enemy
            x + 0,
            y + 0 
        );
        context.closePath();
        context.fill(); 
    }

    function keyDown(/** @type {KeyboardEvent}*/ event) {
        switch(event.keyCode){
            case 32: // space bar (Shoot laser)
                //shootLaser();
                break;
            case 37: // left arrow (move ship left)
                ship.thrustingLeft = true;
                break;
            case 39: // right arrow (rotate ship right)
                ship.thrustingRight = true;
                break;
        }
    }

    function keyUp(/** @type {KeyboardEvent}*/ event) {
        switch(event.keyCode){
            case 32: // space bar (allow shooting again)
                break;
                case 37: // left arrow (move ship left)
                ship.thrustingLeft = false;
                break;
            case 39: // right arrow (rotate ship right)
                ship.thrustingRight = false;
                break;
        }
    }

    function newGame() {
        level = 0;
        ship = newShip();
        spawnDefences();
        newLevel();
    }

    function newLevel() {
        levelText = "Level " + (level + 1);
        levelTextAlpha = 1.0;
        spawnEnemies();
    }

    function spawnDefences() {
        // TODO
    }

    function spawnEnemies() {
        enemies = [];
        var x = ENEMY_STARTING_X, y = ENEMY_STARTING_Y;
        for (var i = 1; i < ENEMY_SHIPS_NUM; i++) {
            enemies.push(newEnemy(x, y, Math.ceil(ENEMY_SHIP_SIZE * 1.2)));
            x += ENEMY_SHIP_SIZE * 1.2;
            if (i == 11 || i == 22) {
                tempColor = "yellow"
                x = ENEMY_STARTING_X;
                y += ENEMY_SHIP_SIZE * 1.2;
            }
            if(i == 33 || i == 44) {
                tempColor = "orange"
                x = ENEMY_STARTING_X;
                y += ENEMY_SHIP_SIZE * 1.2
            }
            enemies.push(newEnemy(x, y, Math.ceil(ENEMY_SHIP_SIZE * 1.2)));
        }
    }

    function newEnemy(x, y, radius) {
        var enemyShip = {
            x: x,
            y: y,
            radius: radius,
            thrust: {
                x: 0,
                y: 0
            }
        }
        return enemyShip;
    }

    function update() {
    
        // Draw background (space)
        context.fillStyle = "black";
        context.fillRect(0, 0, canvas.width, canvas.height);

        // Move the ship side to side
        if(ship.thrustingLeft && ship.x > 0 + SHIP_SIZE * 1.4) { // Logic for moving left (stopping at edge)
            ship.thrust.x = -SHIP_SPEED / FPS;
        }
        else if(ship.thrustingRight && ship.x < canvas.width - SHIP_SIZE * 1.4) { // Logic for moving right (stopping at edge)
            ship.thrust.x = SHIP_SPEED / FPS;
        }
        else { // Logic to stop moving
            ship.thrust.x = 0;
        }
        ship.x += ship.thrust.x; // Actual Moving part

        // Draw Ship
        drawShip(ship.x, ship.y);

    
        // Draw Enemy Ships
        var tempColor = "white", x = ENEMY_STARTING_X, y = ENEMY_STARTING_Y, changeDirection = false;
        // for(var i = 1; i <= ENEMY_SHIPS_NUM; i++) {
        //     if (i == 1) {
        //         drawEnemy(x, y, tempColor);
        //         continue;
        //     }
        //     x += ENEMY_SHIP_SIZE * 1.2;
        //     if (i == 12 || i == 23) {
        //         tempColor = "yellow"
        //         x = ENEMY_STARTING_X;
        //         y += ENEMY_SHIP_SIZE * 1.2;
        //     }
        //     if(i == 34 || i == 45) {
        //         tempColor = "orange"
        //         x = ENEMY_STARTING_X;
        //         y += ENEMY_SHIP_SIZE * 1.2
        //     }
        //     drawEnemy(x, y, tempColor);
        // }

        // Move Enemy Ships
        var enemeyMovementSpeed = ENEMY_SHIP_SPEED / FPS;
        for (var i = 0; i < enemies.length; i++) {

            // Handle edge of screen
            if(enemies[i].x < 10 || enemies[i].x >= canvas.width - ENEMY_SHIP_SIZE * 1.2 - ENEMY_STARTING_X) { // Logic for moving left (stopping at edge)
                changeDirection = true;
                console.log("Change Directions");
            }
            if(changeDirection) {
                enemeyMovementSpeed = -enemies[i].thrust.x;
                changeDirection = false;
            }
                enemies[i].thrust.x = ENEMY_SHIP_SPEED / FPS;
                enemies[i].x += enemeyMovementSpeed; // Actual Moving part
                drawEnemy(enemies[i].x, enemies[i].y,"white");
        }
    }

    </script>
</body>

</html>